"use strict";var __awaiter=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(f,g){function h(l){try{k(d.next(l))}catch(m){g(m)}}function j(l){try{k(d["throw"](l))}catch(m){g(m)}}function k(l){l.done?f(l.value):new c(function(m){m(l.value)}).then(h,j)}k((d=d.apply(a,b)).next())})};class Folder{constructor(a){this.name=a,this.files=[]}}exports.Folder=Folder;class UserArchive{constructor(a){this.name=a,this.folders=[]}}exports.UserArchive=UserArchive;class StockCenterListItem{constructor(a,b,c,d,f,g){this.stockCenter=a,this.mcds=b,this.stockService=c,this.username=d,this.password=f,this.expanded=g,this.isActive=!1}tryConnect(){return __awaiter(this,void 0,void 0,function*(){for(let a=0;a<this.stockCenter.URLs.length;a++)try{let b=this.stockCenter.URLs[a];if(this.stockService.$baseURL=b.URL,yield this.stockService.test())return this.isActive=!0,!0}catch(b){}return!1})}getFiles(){return __awaiter(this,void 0,void 0,function*(){function a(g,h){f[g]||(f[g]={});let j=f[g];return j[h]||(j[h]=new Folder(h)),j[h]}if(!this.tryConnect())return void console.warn("Failed in connecting to stock server <"+this.stockCenter.Name+">");let c,b=yield this.stockService.createToken(this.username);-1<this.stockCenter.Managers.indexOf(this.username)?c=yield this.mcds.endorseManagerForStockCenter(this.username,this.password,this.stockCenter._id,b):-1<this.stockCenter.Members.indexOf(this.username)&&(c=yield this.mcds.endorseUserForStockCenter(this.username,this.password,this.stockCenter._id,b)),this.code=yield this.stockService.checkToken(this.username,c),this.stockCenterInfo=yield this.stockService.getStockCenter(this.username,this.code,this.stockCenter._id),this.expanded=!0;let d=yield this.stockService.getFilesForUser(this.username,this.code),f={};for(let g in f[this.username]={},f[this.username]["<No Tag>"]=new Folder("<No Tag>"),d.forEach(g=>{g.folders&&0<g.folders.length?g.folders.forEach(h=>{a(g.owner,h).files.push(g)}):a(g.owner,"<No Tag>").files.push(g)}),this.users=[],f){let h=new UserArchive(g);for(let j in f[g])h.folders.push(f[g][j]);this.users.push(h)}console.log("expanded: ",this.expanded)})}saveFileToStockCenter(a,b,c){return __awaiter(this,void 0,void 0,function*(){c.owner=this.username,yield this.stockService.saveFile(this.username,this.code,c)})}readFile(a){return __awaiter(this,void 0,void 0,function*(){return yield this.stockService.readFile(this.username,this.code,a)})}}exports.StockCenterListItem=StockCenterListItem;