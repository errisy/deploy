"use strict";var __decorate=this&&this.__decorate||function(a,b,f,g){var l,h=arguments.length,j=3>h?b:null===g?g=Object.getOwnPropertyDescriptor(b,f):g;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)j=Reflect.decorate(a,b,f,g);else for(var m=a.length-1;0<=m;m--)(l=a[m])&&(j=(3>h?l(j):3<h?l(b,f,j):l(b,f))||j);return 3<h&&j&&Object.defineProperty(b,f,j),j},__metadata=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)},__awaiter=this&&this.__awaiter||function(a,b,f,g){return new(f||(f=Promise))(function(h,j){function l(o){try{n(g.next(o))}catch(p){j(p)}}function m(o){try{n(g["throw"](o))}catch(p){j(p)}}function n(o){o.done?h(o.value):new f(function(p){p(o.value)}).then(l,m)}n((g=g.apply(a,b)).next())})};const core_1=require("@angular/core"),content_1=require("../ui/content"),management_client_1=require("./management.client"),util=require("errisy-util"),errisy_ui_1=require("errisy-ui");let GeneralComponent=class{constructor(b,f,g){this.manage=b,this.parent=f,this.changeDetectorRef=g,this.PasswordModel=new errisy_ui_1.NewPasswordModel,this.Tabs=[{Title:"Information",View:[[errisy_ui_1.fields.text("_id","Username").readonly()],[errisy_ui_1.fields.text("name","Name").attr({maxlength:64})],[errisy_ui_1.fields.text("email","Email").verify(errisy_ui_1.verifictions.email).attr({maxlength:64})],[errisy_ui_1.fields.text("Company","Company Name").attr({maxlength:128})],[errisy_ui_1.fields.text("ContactPhone","Contact Phone").attr({maxlength:32})],errisy_ui_1.rows.text(errisy_ui_1.fields.textarea("BillingAddress","Billing Address").attr({maxlength:128})),errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Update").event("click",this,()=>__awaiter(this,void 0,void 0,function*(){(yield this.View.Verify())&&(this.parent.Status="Updating Information...",this.parent.Status=(yield this.manage.UpdateAccountInformation(this.View.Entity))?"Information Updated.":"Failed to Update Information.")})))],Entity:()=>__awaiter(this,void 0,void 0,function*(){return yield this.manage.GetAccountInformation()})},{Title:"Activate/Change Mobile",View:[[errisy_ui_1.fields.text("active","Your Mobile Status").readonly()],[errisy_ui_1.fields.text("mobile","Mobile Phone Number").event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.numbers).attr({maxlength:10})],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Get Activation Code").event("click",this,()=>__awaiter(this,void 0,void 0,function*(){this.parent.Status="Trying to get Verification Code...";try{(yield this.manage.getMobileVerificationCode(this.View.Entity.mobile))&&(this.parent.Status="Verfication code will be sent to you in a minute.")}catch(h){this.parent.Status=h}}))),[errisy_ui_1.fields.text("code","Activation Code").event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.numbers).verify(errisy_ui_1.verifictions.fixedLength(6)).attr({maxlength:6})],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Activate").event("click",this,()=>__awaiter(this,void 0,void 0,function*(){if(this.View.Verify()){this.parent.Status="Trying to verify your mobile...";try{(yield this.manage.verifyMobile(this.View.Entity.code))&&(this.View.Entity.active="Active",this.parent.Status="Your mobile is activated!")}catch(h){this.parent.Status=h}}})))],Entity:()=>__awaiter(this,void 0,void 0,function*(){return yield this.manage.getActivationEntity()})},{Title:"Change Password",View:[[errisy_ui_1.fields.password("password","Old Password").verify(errisy_ui_1.verifictions.required)],[errisy_ui_1.fields.password1(this.PasswordModel,"New"),errisy_ui_1.fields.password2(this.PasswordModel,"Repeat")],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Change Password").event("click",this,()=>__awaiter(this,void 0,void 0,function*(){if((console.log("verify ",(yield this.View.Verify())),!!(yield this.View.Verify()))&&(this.parent.Status="Trying to change your password...",console.log(this.View.Entity,this.PasswordModel.Value),!!this.PasswordModel.Value))try{(yield this.manage.changePassword(util.md5(this.View.Entity.password),util.md5(this.PasswordModel.Value)))?(this.parent.Status="Password Changed.",this.PasswordModel.Value=""):this.parent.Status="Failed to change your password."}catch(h){this.parent.Status=h}})))],Entity:()=>__awaiter(this,void 0,void 0,function*(){return{password:""}})}]}ngAfterContentInit(){return __awaiter(this,void 0,void 0,function*(){return(yield this.parent.checkLogin())?void(this.parent.Title="General Setting",!this.SelectedTab&&(yield this.SelectTab(this.Tabs[0])),this.changeDetectorRef.markForCheck()):void this.parent.select(0)})}SelectTab(b){return __awaiter(this,void 0,void 0,function*(){this.SelectedTab=b,this.View.Load(b.View),this.View.Entity=yield b.Entity()})}};__decorate([core_1.ViewChild("header"),__metadata("design:type",errisy_ui_1.InfoTableControl)],GeneralComponent.prototype,"Header",void 0),__decorate([core_1.ViewChild("view"),__metadata("design:type",errisy_ui_1.InfoTableControl)],GeneralComponent.prototype,"View",void 0),GeneralComponent=__decorate([core_1.Component({selector:"crispr-site",template:" <div class=\"flex-column-stretch flex-stretch\"> <div class=\"flex-row-stretch view-title\"> <div class=\"flex-row-center flex-stretch flex-center\"> <span style=\"cursor: default; user-select: none\">{{parent.Title}}</span> </div> </div> <div class=\"flex-column-stretch flex-stretch flex-center warm-gradient\"> <div class=\"flex-row-stretch tab\"> <div *ngFor=\"let tab of Tabs\" [class.selected]=\"SelectedTab==tab\" (click)=\"SelectTab(tab)\">{{tab.Title}}</div> </div> <div class=\"flex-column-center flex-stretch flex-start\"> <div info-table #view> </div> </div> </div> <div class=\"flex-row-center view-status\"> {{parent.Status}} </div> </div>",providers:[management_client_1.ManageCore]}),__metadata("design:paramtypes",[management_client_1.ManageCore,content_1.ContentControl,core_1.ChangeDetectorRef])],GeneralComponent),exports.GeneralComponent=GeneralComponent;