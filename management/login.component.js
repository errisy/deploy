"use strict";var _createClass=function(){function a(b,f){for(var h,g=0;g<f.length;g++)h=f[g],h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(b,h.key,h)}return function(b,f,g){return f&&a(b.prototype,f),g&&a(b,g),b}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"==typeof b||"function"==typeof b)?b:a}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var __decorate=function(a,b,f,g){var l,h=arguments.length,j=3>h?b:null===g?g=Object.getOwnPropertyDescriptor(b,f):g;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)j=Reflect.decorate(a,b,f,g);else for(var m=a.length-1;0<=m;m--)(l=a[m])&&(j=(3>h?l(j):3<h?l(b,f,j):l(b,f))||j);return 3<h&&j&&Object.defineProperty(b,f,j),j},__metadata=function(a,b){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)},__awaiter=function(a,b,f,g){return new(f||(f=Promise))(function(h,j){function l(o){try{n(g.next(o))}catch(p){j(p)}}function m(o){try{n(g["throw"](o))}catch(p){j(p)}}function n(o){o.done?h(o.value):new f(function(p){p(o.value)}).then(l,m)}n((g=g.apply(a,b)).next())})},core_1=require("@angular/core"),content_1=require("ui/content"),errisy_ui_1=require("errisy-ui"),management_client_1=require("management/management.client"),util=require("errisy-util"),LoginComponent=function(a){function b(f,g,h){_classCallCheck(this,b);var j=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,f,g));return j.changeDetectorRef=f,j.parent=g,j.manage=h,j.FormTitle="Login",j.RegisterEntity={Username:"",Password:new errisy_ui_1.NewPasswordModel,Captcha:"",Mobile:"04",MobileInfo:"Valid Mobile is Required to Activate Your Account.",Login:"Back to Login.",Long:!0},j.RetrieveEntity={Username:"",Mobile:"",ToLogin:"To Login",ToRegister:"Regist New"},j}return _inherits(b,a),_createClass(b,[{key:"FixRegisterUsername",value:function(g){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function h(){var j,l;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(!/^[a-z0-9]+$/i.test(g)){for(j=[],l=0;l<g.length;l++)/[a-z0-9]/i.test(g.charAt(l))&&j.push(g.charAt(l));this.RegisterEntity.Username=j.join("")}case 1:case"end":return n.stop();}},h,this)}))}},{key:"onRegister",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function g(){var h;return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:return l.next=2,this.View.Verify();case 2:if(l.sent){l.next=4;break}return l.abrupt("return");case 4:return this.parent.Status="Registering...",l.prev=5,l.next=8,this.manage.register(this.RegisterEntity.Username,util.md5(this.RegisterEntity.Password.Value),this.RegisterEntity.Captcha,this.RegisterEntity.Mobile,this.RegisterEntity.Long);case 8:if(h=l.sent,!h){l.next=16;break}return this.parent.username=this.RegisterEntity.Username,this.parent.Status="Account Created!",l.next=14,this.toUser();case 14:l.next=17;break;case 16:this.parent.Status="Registration Failed!";case 17:l.next=22;break;case 19:l.prev=19,l.t0=l["catch"](5),this.parent.Status=l.t0;case 22:case"end":return l.stop();}},g,this,[[5,19]])}))}},{key:"onCheckUsername",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function g(){var h,j,l;return regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:if(h=this.RegisterEntity.Username,!/^[a-z0-9]+$/i.test(h)){for(j=[],l=0;l<h.length;l++)/[a-z0-9]/i.test(h.charAt(l))&&j.push(h.charAt(l));this.RegisterEntity.Username=j.join("")}case 2:case"end":return n.stop();}},g,this)}))}},{key:"onRetreivePassword",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function g(){return regeneratorRuntime.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(this.View.Verify()){j.next=2;break}return j.abrupt("return");case 2:return j.prev=2,j.next=5,this.manage.RetrievePassword(this.RetrieveEntity.Username,this.RetrieveEntity.Mobile);case 5:if(!j.sent){j.next=7;break}this.parent.Status="You will receive your new password in 2 min.";case 7:j.next=12;break;case 9:j.prev=9,j.t0=j["catch"](2),this.parent.Status=j.t0;case 12:case"end":return j.stop();}},g,this,[[2,9]])}))}},{key:"toRetrieveExtends",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function g(){return regeneratorRuntime.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:this.RetrieveEntity.Username="",this.RetrieveEntity.Mobile="04";case 2:case"end":return j.stop();}},g,this)}))}},{key:"LoginView",get:function(){return[[errisy_ui_1.fields.text("Username","Username").attr({maxlength:30}).event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.letters).event("keydown",this,this.onLoginByKeyDown)],[errisy_ui_1.fields.password("Password","Password").event("keydown",this,this.onLoginByKeyDown)],[errisy_ui_1.fields.checkbox("Long","Keep 2 Weeks")],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Regist").event("click",this,this.toRegister),errisy_ui_1.fields.submit("Login").event("click",this,this.onLogin)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("ForgetPassword","Retrieve Your Password").event("click",this,this.toRetrieve).default("Forget Password?"))]}},{key:"RegisterView",get:function(){var g=this;return[[errisy_ui_1.fields.text("Username","Username").attr({maxlength:30}).event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.letters).event("ngModelChange",this,this.FixRegisterUsername).event("blur",this,this.onCheckUsername).verify(errisy_ui_1.verifictions.required).verify(function(h){return __awaiter(g,void 0,void 0,regeneratorRuntime.mark(function j(){return regeneratorRuntime.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return m.abrupt("return",30>=h.length?{Result:!0}:{Result:!1,Status:"Longer than 30 chars!"});case 1:case"end":return m.stop();}},j,this)}))}).contextVerify(this,function(h){return __awaiter(g,void 0,void 0,regeneratorRuntime.mark(function j(){return regeneratorRuntime.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return m.next=2,this.manage.isUsernameAvailable(h);case 2:if(!m.sent){m.next=6;break}m.t0={Result:!0},m.next=7;break;case 6:m.t0={Result:!1,Status:"Username already exists!"};case 7:return m.abrupt("return",m.t0);case 8:case"end":return m.stop();}},j,this)}))})],[errisy_ui_1.fields.password1(this.RegisterEntity.Password),errisy_ui_1.fields.password2(this.RegisterEntity.Password)],[errisy_ui_1.fields.capchaimage(this.manage["captchaImage url"]),errisy_ui_1.fields.text("Captcha","Captcha Code").attr({maxlength:6}).verify(function(h){return __awaiter(g,void 0,void 0,regeneratorRuntime.mark(function j(){return regeneratorRuntime.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return m.next=2,this.manage.checkCaptch(h);case 2:if(!m.sent){m.next=6;break}m.t0={Result:!0},m.next=7;break;case 6:m.t0={Result:!1,Status:"Wrong!"};case 7:return m.abrupt("return",m.t0);case 8:case"end":return m.stop();}},j,this)}))})],errisy_ui_1.rows.link(errisy_ui_1.fields.click("MobileInfo")),[errisy_ui_1.fields.text("Mobile","Your Mobile Number").event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.numbers).verify(function(h){return __awaiter(g,void 0,void 0,regeneratorRuntime.mark(function j(){return regeneratorRuntime.wrap(function(m){for(;;)switch(m.prev=m.next){case 0:return m.abrupt("return",/^04\d{8}$/g.test(h)?{Result:!0}:{Result:!1,Status:"Invalid!"});case 1:case"end":return m.stop();}},j,this)}))})],[errisy_ui_1.fields.checkbox("Long","Keep Login For 2 Weeks")],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Register").event("click",this,this.onRegister)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("Login").event("click",this,this.toLogin))]}},{key:"RetrieveView",get:function(){return[[errisy_ui_1.fields.text("Username","Username").css({"ime-mode":"inactive"}).attr({maxlength:30}).verify(errisy_ui_1.verifictions.required)],[errisy_ui_1.fields.text("Mobile","Mobile Number").attr({pattern:"/04d{8}/"}).event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.numbers).verify(errisy_ui_1.verifictions.fixedLength(10))],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Retreive Password").event("click",this,this.onRetreivePassword)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("ToLogin","Back to Login").event("click",this,this.toLogin),errisy_ui_1.fields.click("ToRegister","Regist New").event("click",this,this.toRegister))]}}]),b}(content_1.LoginComponentModel);LoginComponent=__decorate([core_1.Component({selector:"admin-login",template:" <div class=\"flex-column-stretch flex-stretch\"> <div class=\"flex-row-stretch view-title\"> <div class=\"flex-row-center flex-stretch flex-center\"> <span style=\"cursor: default; user-select: none\">{{parent.Title}}</span> </div> </div> <div class=\"flex-column-center flex-stretch flex-center warm-gradient\"> <div info-table #view> </div> </div> <div class=\"flex-row-center view-status\"> {{parent.Status}} </div> </div>",providers:[management_client_1.ManageCore]}),__metadata("design:paramtypes",[core_1.ChangeDetectorRef,content_1.ContentControl,management_client_1.ManageCore])],LoginComponent),exports.LoginComponent=LoginComponent;