"use strict";var __decorate=this&&this.__decorate||function(a,b,f,g){var l,h=arguments.length,j=3>h?b:null===g?g=Object.getOwnPropertyDescriptor(b,f):g;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)j=Reflect.decorate(a,b,f,g);else for(var m=a.length-1;0<=m;m--)(l=a[m])&&(j=(3>h?l(j):3<h?l(b,f,j):l(b,f))||j);return 3<h&&j&&Object.defineProperty(b,f,j),j},__metadata=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)},__awaiter=this&&this.__awaiter||function(a,b,f,g){return new(f||(f=Promise))(function(h,j){function l(o){try{n(g.next(o))}catch(p){j(p)}}function m(o){try{n(g["throw"](o))}catch(p){j(p)}}function n(o){o.done?h(o.value):new f(function(p){p(o.value)}).then(l,m)}n((g=g.apply(a,b)).next())})};const core_1=require("@angular/core"),content_1=require("../ui/content"),errisy_ui_1=require("errisy-ui"),management_client_1=require("./management.client"),util=require("errisy-util");let LoginComponent=class extends content_1.LoginComponentModel{constructor(b,f,g){super(b,f),this.changeDetectorRef=b,this.parent=f,this.manage=g,this.FormTitle="Login",this.RegisterEntity={Username:"",Password:new errisy_ui_1.NewPasswordModel,Captcha:"",Mobile:"04",MobileInfo:"Valid Mobile is Required to Activate Your Account.",Login:"Back to Login.",Long:!0},this.RetrieveEntity={Username:"",Mobile:"",ToLogin:"To Login",ToRegister:"Regist New"}}FixRegisterUsername(b){return __awaiter(this,void 0,void 0,function*(){if(!/^[a-z0-9]+$/i.test(b)){let f=[];for(let g=0;g<b.length;g++)/[a-z0-9]/i.test(b.charAt(g))&&f.push(b.charAt(g));this.RegisterEntity.Username=f.join("")}})}get LoginView(){return[[errisy_ui_1.fields.text("Username","Username").attr({maxlength:30}).event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.letters).event("keydown",this,this.onLoginByKeyDown)],[errisy_ui_1.fields.password("Password","Password").event("keydown",this,this.onLoginByKeyDown)],[errisy_ui_1.fields.checkbox("Long","Keep 2 Weeks")],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Regist").event("click",this,this.toRegister),errisy_ui_1.fields.submit("Login").event("click",this,this.onLogin)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("ForgetPassword","Retrieve Your Password").event("click",this,this.toRetrieve).default("Forget Password?"))]}get RegisterView(){return[[errisy_ui_1.fields.text("Username","Username").attr({maxlength:30}).event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.letters).event("ngModelChange",this,this.FixRegisterUsername).event("blur",this,this.onCheckUsername).verify(errisy_ui_1.verifictions.required).verify(b=>__awaiter(this,void 0,void 0,function*(){return 30>=b.length?{Result:!0}:{Result:!1,Status:"Longer than 30 chars!"}})).contextVerify(this,b=>__awaiter(this,void 0,void 0,function*(){return(yield this.manage.isUsernameAvailable(b))?{Result:!0}:{Result:!1,Status:"Username already exists!"}}))],[errisy_ui_1.fields.password1(this.RegisterEntity.Password),errisy_ui_1.fields.password2(this.RegisterEntity.Password)],[errisy_ui_1.fields.capchaimage(this.manage["captchaImage url"]),errisy_ui_1.fields.text("Captcha","Captcha Code").attr({maxlength:6}).verify(b=>__awaiter(this,void 0,void 0,function*(){return(yield this.manage.checkCaptch(b))?{Result:!0}:{Result:!1,Status:"Wrong!"}}))],errisy_ui_1.rows.link(errisy_ui_1.fields.click("MobileInfo")),[errisy_ui_1.fields.text("Mobile","Your Mobile Number").event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.numbers).verify(b=>__awaiter(this,void 0,void 0,function*(){return /^04\d{8}$/g.test(b)?{Result:!0}:{Result:!1,Status:"Invalid!"}}))],[errisy_ui_1.fields.checkbox("Long","Keep Login For 2 Weeks")],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Register").event("click",this,this.onRegister)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("Login").event("click",this,this.toLogin))]}onRegister(){return __awaiter(this,void 0,void 0,function*(){if(yield this.View.Verify()){this.parent.Status="Registering...";try{let b=yield this.manage.register(this.RegisterEntity.Username,util.md5(this.RegisterEntity.Password.Value),this.RegisterEntity.Captcha,this.RegisterEntity.Mobile,this.RegisterEntity.Long);b?(this.parent.username=this.RegisterEntity.Username,this.parent.Status="Account Created!",yield this.toUser()):this.parent.Status="Registration Failed!"}catch(b){this.parent.Status=b}}})}onCheckUsername(){return __awaiter(this,void 0,void 0,function*(){let b=this.RegisterEntity.Username;if(!/^[a-z0-9]+$/i.test(b)){let f=[];for(let g=0;g<b.length;g++)/[a-z0-9]/i.test(b.charAt(g))&&f.push(b.charAt(g));this.RegisterEntity.Username=f.join("")}})}onRetreivePassword(){return __awaiter(this,void 0,void 0,function*(){if(this.View.Verify())try{(yield this.manage.RetrievePassword(this.RetrieveEntity.Username,this.RetrieveEntity.Mobile))&&(this.parent.Status="You will receive your new password in 2 min.")}catch(b){this.parent.Status=b}})}toRetrieveExtends(){return __awaiter(this,void 0,void 0,function*(){this.RetrieveEntity.Username="",this.RetrieveEntity.Mobile="04"})}get RetrieveView(){return[[errisy_ui_1.fields.text("Username","Username").css({"ime-mode":"inactive"}).attr({maxlength:30}).verify(errisy_ui_1.verifictions.required)],[errisy_ui_1.fields.text("Mobile","Mobile Number").attr({pattern:"/04d{8}/"}).event("keydown",errisy_ui_1.filters,errisy_ui_1.filters.numbers).verify(errisy_ui_1.verifictions.fixedLength(10))],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Retreive Password").event("click",this,this.onRetreivePassword)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("ToLogin","Back to Login").event("click",this,this.toLogin),errisy_ui_1.fields.click("ToRegister","Regist New").event("click",this,this.toRegister))]}};LoginComponent=__decorate([core_1.Component({selector:"admin-login",template:" <div class=\"flex-column-stretch flex-stretch\"> <div class=\"flex-row-stretch view-title\"> <div class=\"flex-row-center flex-stretch flex-center\"> <span style=\"cursor: default; user-select: none\">{{parent.Title}}</span> </div> </div> <div class=\"flex-column-center flex-stretch flex-center warm-gradient\"> <div info-table #view> </div> </div> <div class=\"flex-row-center view-status\"> {{parent.Status}} </div> </div>",providers:[management_client_1.ManageCore]}),__metadata("design:paramtypes",[core_1.ChangeDetectorRef,content_1.ContentControl,management_client_1.ManageCore])],LoginComponent),exports.LoginComponent=LoginComponent;