"use strict";var __decorate=this&&this.__decorate||function(a,b,e,f){var j,g=arguments.length,h=3>g?b:null===f?f=Object.getOwnPropertyDescriptor(b,e):f;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)h=Reflect.decorate(a,b,e,f);else for(var l=a.length-1;0<=l;l--)(j=a[l])&&(h=(3>g?j(h):3<g?j(b,e,h):j(b,e))||h);return 3<g&&h&&Object.defineProperty(b,e,h),h},__metadata=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)},__param=this&&this.__param||function(a,b){return function(e,f){b(e,f,a)}},core_1=require("@angular/core"),Rx_1=require("rxjs/Rx"),ctr_completer_1=require("./ctr-completer"),globals_1=require("../globals"),CtrListContext=function(){return function(b,e,f){this.results=b,this.searching=e,this.searchInitialized=f}}();exports.CtrListContext=CtrListContext;var CtrList=CtrList_1=function(){function a(b,e,f,g){this.completer=b,this.templateRef=e,this.viewContainer=f,this.cd=g,this.ctrListMinSearchLength=globals_1.MIN_SEARCH_LENGTH,this.ctrListPause=globals_1.PAUSE,this.ctrListAutoMatch=!1,this.term=null,this.searchTimer=null,this.clearTimer=null,this.ctx=new CtrListContext([],!1,!1)}return a.hasTerm=function(b){return b||""===b},a.prototype.ngOnInit=function(){this.completer.registerList(this),this.viewContainer.createEmbeddedView(this.templateRef,new CtrListContext([],!1,!1))},Object.defineProperty(a.prototype,"dataService",{set:function(b){var e=this;this._dataService=b,this._dataService&&this._dataService.catch(function(f){return e.handleError(f)}).subscribe(function(f){e.ctx.searchInitialized=!0,e.ctx.searching=!1,e.ctx.results=f,e.ctrListAutoMatch&&1===f.length&&f[0].title&&CtrList_1.hasTerm(e.term)&&f[0].title.toLocaleLowerCase()===e.term.toLocaleLowerCase()&&e.completer.onSelected(f[0]),e.refreshTemplate()})},enumerable:!0,configurable:!0}),a.prototype.search=function(b){var e=this;this.term!=b&&this.completer.clear(),CtrList_1.hasTerm(b)&&b.length>=this.ctrListMinSearchLength&&this.term!==b&&(this.searchTimer&&(this.searchTimer.unsubscribe(),this.searchTimer=null),!this.ctx.searching&&(this.ctx.results=[],this.ctx.searching=!0,this.ctx.searchInitialized=!0,this.refreshTemplate()),this.clearTimer&&this.clearTimer.unsubscribe(),this.searchTimer=Rx_1.Observable.timer(this.ctrListPause).subscribe(function(){e.searchTimerComplete(b)}))},a.prototype.clear=function(){var b=this;this.searchTimer&&this.searchTimer.unsubscribe(),this.clearTimer=Rx_1.Observable.timer(globals_1.CLEAR_TIMEOUT).subscribe(function(){b._clear()})},a.prototype._clear=function(){this.searchTimer&&(this.searchTimer.unsubscribe(),this.searchTimer=null),this.dataService&&this.dataService.cancel(),this.ctx.results=[],this.ctx.searchInitialized=!1,this.term=null,this.viewContainer.clear()},a.prototype.searchTimerComplete=function(b){return!CtrList_1.hasTerm(b)||b.length<this.ctrListMinSearchLength?void(this.ctx.searching=!1):void(this.term=b,this._dataService.search(b))},a.prototype.handleError=function(b){this.ctx.searching=!1;var e="search error";return b&&(e=b.message?b.message:b.status?b.status+" - "+b.statusText:"Server error"),console&&console.error&&console.error(e),this.refreshTemplate(),Rx_1.Observable.throw(e)},a.prototype.refreshTemplate=function(){this.viewContainer.clear(),this.viewContainer.createEmbeddedView(this.templateRef,this.ctx),this.cd.markForCheck()},a}();__decorate([core_1.Input(),__metadata("design:type",Object)],CtrList.prototype,"ctrListMinSearchLength",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],CtrList.prototype,"ctrListPause",void 0),__decorate([core_1.Input(),__metadata("design:type",Object)],CtrList.prototype,"ctrListAutoMatch",void 0),__decorate([core_1.Input("ctrList"),__metadata("design:type",Object),__metadata("design:paramtypes",[Object])],CtrList.prototype,"dataService",null),CtrList=CtrList_1=__decorate([core_1.Directive({selector:"[ctrList]"}),__param(0,core_1.Host()),__metadata("design:paramtypes",[ctr_completer_1.CtrCompleter,core_1.TemplateRef,core_1.ViewContainerRef,core_1.ChangeDetectorRef])],CtrList),exports.CtrList=CtrList;var CtrList_1;