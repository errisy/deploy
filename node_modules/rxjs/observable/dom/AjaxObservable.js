'use strict';var __extends=this&&this.__extends||function(a,c){function f(){this.constructor=a}for(var g in c)c.hasOwnProperty(g)&&(a[g]=c[g]);a.prototype=null===c?Object.create(c):(f.prototype=c.prototype,new f)},root_1=require('../../util/root'),tryCatch_1=require('../../util/tryCatch'),errorObject_1=require('../../util/errorObject'),Observable_1=require('../../Observable'),Subscriber_1=require('../../Subscriber'),map_1=require('../../operator/map');function getCORSRequest(){if(root_1.root.XMLHttpRequest){var a=new root_1.root.XMLHttpRequest;return'withCredentials'in a&&(a.withCredentials=!!this.withCredentials),a}if(!!root_1.root.XDomainRequest)return new root_1.root.XDomainRequest;throw new Error('CORS is not supported by your browser')}function getXMLHttpRequest(){if(root_1.root.XMLHttpRequest)return new root_1.root.XMLHttpRequest;var a;try{for(var c=['Msxml2.XMLHTTP','Microsoft.XMLHTTP','Msxml2.XMLHTTP.4.0'],f=0;3>f;f++)try{if(a=c[f],new root_1.root.ActiveXObject(a))break}catch(g){}return new root_1.root.ActiveXObject(a)}catch(g){throw new Error('XMLHttpRequest is not supported by your browser')}}function ajaxGet(a,c){return void 0===c&&(c=null),new AjaxObservable({method:'GET',url:a,headers:c})}exports.ajaxGet=ajaxGet;function ajaxPost(a,c,f){return new AjaxObservable({method:'POST',url:a,body:c,headers:f})}exports.ajaxPost=ajaxPost;function ajaxDelete(a,c){return new AjaxObservable({method:'DELETE',url:a,headers:c})}exports.ajaxDelete=ajaxDelete;function ajaxPut(a,c,f){return new AjaxObservable({method:'PUT',url:a,body:c,headers:f})}exports.ajaxPut=ajaxPut;function ajaxGetJSON(a,c){return new AjaxObservable({method:'GET',url:a,responseType:'json',headers:c}).lift(new map_1.MapOperator(function(f){return f.response},null))}exports.ajaxGetJSON=ajaxGetJSON;var AjaxObservable=function(a){function c(f){a.call(this);var g={async:!0,createXHR:function(){return this.crossDomain?getCORSRequest.call(this):getXMLHttpRequest()},crossDomain:!1,withCredentials:!1,headers:{},method:'GET',responseType:'json',timeout:0};if('string'==typeof f)g.url=f;else for(var h in f)f.hasOwnProperty(h)&&(g[h]=f[h]);this.request=g}return __extends(c,a),c.prototype._subscribe=function(f){return new AjaxSubscriber(f,this.request)},c.create=function(){var f=function(g){return new c(g)};return f.get=ajaxGet,f.post=ajaxPost,f.delete=ajaxDelete,f.put=ajaxPut,f.getJSON=ajaxGetJSON,f}(),c}(Observable_1.Observable);exports.AjaxObservable=AjaxObservable;var AjaxSubscriber=function(a){function c(f,g){a.call(this,f),this.request=g,this.done=!1;var h=g.headers=g.headers||{};g.crossDomain||h['X-Requested-With']||(h['X-Requested-With']='XMLHttpRequest'),'Content-Type'in h||root_1.root.FormData&&g.body instanceof root_1.root.FormData||'undefined'==typeof g.body||(h['Content-Type']='application/x-www-form-urlencoded; charset=UTF-8'),g.body=this.serializeBody(g.body,g.headers['Content-Type']),this.send()}return __extends(c,a),c.prototype.next=function(f){this.done=!0;var g=this,h=g.xhr,j=g.request,k=g.destination,l=new AjaxResponse(f,h,j);k.next(l)},c.prototype.send=function(){var f=this,g=f.request,h=f.request,j=h.user,k=h.method,l=h.url,m=h.async,n=h.password,o=h.headers,q=h.body,r=g.createXHR,s=tryCatch_1.tryCatch(r).call(g);if(s===errorObject_1.errorObject)this.error(errorObject_1.errorObject.e);else{this.xhr=s;var t;if(t=j?tryCatch_1.tryCatch(s.open).call(s,k,l,m,j,n):tryCatch_1.tryCatch(s.open).call(s,k,l,m),t===errorObject_1.errorObject)return this.error(errorObject_1.errorObject.e),null;s.timeout=g.timeout,s.responseType=g.responseType,this.setHeaders(s,o),this.setupEvents(s,g),q?s.send(q):s.send()}return s},c.prototype.serializeBody=function(f,g){if(!f||'string'==typeof f)return f;if(root_1.root.FormData&&f instanceof root_1.root.FormData)return f;if(g){var h=g.indexOf(';');-1!==h&&(g=g.substring(0,h))}return'application/x-www-form-urlencoded'===g?Object.keys(f).map(function(j){return encodeURI(j)+'='+encodeURI(f[j])}).join('&'):'application/json'===g?JSON.stringify(f):f},c.prototype.setHeaders=function(f,g){for(var h in g)g.hasOwnProperty(h)&&f.setRequestHeader(h,g[h])},c.prototype.setupEvents=function(f,g){var h=g.progressSubscriber;f.ontimeout=function j(k){var l=j,m=l.subscriber,n=l.progressSubscriber,o=l.request;n&&n.error(k),m.error(new AjaxTimeoutError(this,o))},f.ontimeout.request=g,f.ontimeout.subscriber=this,f.ontimeout.progressSubscriber=h,f.upload&&'withCredentials'in f&&root_1.root.XDomainRequest&&(h&&(f.onprogress=function j(k){var l=j.progressSubscriber;l.next(k)},f.onprogress.progressSubscriber=h),f.onerror=function j(k){var l=j,m=l.progressSubscriber,n=l.subscriber,o=l.request;m&&m.error(k),n.error(new AjaxError('ajax error',this,o))},f.onerror.request=g,f.onerror.subscriber=this,f.onerror.progressSubscriber=h),f.onreadystatechange=function j(k){var l=j,m=l.subscriber,n=l.progressSubscriber,o=l.request;if(4===this.readyState){var q=1223===this.status?204:this.status,r='text'===this.responseType?this.response||this.responseText:this.response;0===q&&(q=r?200:0),200<=q&&300>q?(n&&n.complete(),m.next(k),m.complete()):(n&&n.error(k),m.error(new AjaxError('ajax error '+q,this,o)))}},f.onreadystatechange.subscriber=this,f.onreadystatechange.progressSubscriber=h,f.onreadystatechange.request=g},c.prototype.unsubscribe=function(){var f=this,g=f.done,h=f.xhr;!g&&h&&4!==h.readyState&&h.abort(),a.prototype.unsubscribe.call(this)},c}(Subscriber_1.Subscriber);exports.AjaxSubscriber=AjaxSubscriber;var AjaxResponse=function(){return function(c,f,g){switch(this.originalEvent=c,this.xhr=f,this.request=g,this.status=f.status,this.responseType=f.responseType||g.responseType,this.responseType){case'json':this.response='response'in f?f.responseType?f.response:JSON.parse(f.response||f.responseText||'null'):JSON.parse(f.responseText||'null');break;case'xml':this.response=f.responseXML;break;case'text':default:this.response='response'in f?f.response:f.responseText;}}}();exports.AjaxResponse=AjaxResponse;var AjaxError=function(a){function c(f,g,h){a.call(this,f),this.message=f,this.xhr=g,this.request=h,this.status=g.status}return __extends(c,a),c}(Error);exports.AjaxError=AjaxError;var AjaxTimeoutError=function(a){function c(f,g){a.call(this,'ajax timeout',f,g)}return __extends(c,a),c}(AjaxError);exports.AjaxTimeoutError=AjaxTimeoutError;