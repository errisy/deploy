'use strict';var __extends=this&&this.__extends||function(a,c){function f(){this.constructor=a}for(var g in c)c.hasOwnProperty(g)&&(a[g]=c[g]);a.prototype=null===c?Object.create(c):(f.prototype=c.prototype,new f)},Subject_1=require('../../Subject'),Subscriber_1=require('../../Subscriber'),Observable_1=require('../../Observable'),Subscription_1=require('../../Subscription'),root_1=require('../../util/root'),ReplaySubject_1=require('../../ReplaySubject'),tryCatch_1=require('../../util/tryCatch'),errorObject_1=require('../../util/errorObject'),assign_1=require('../../util/assign'),WebSocketSubject=function(a){function c(f,g){if(f instanceof Observable_1.Observable)a.call(this,g,f);else{if(a.call(this),this.WebSocketCtor=root_1.root.WebSocket,this._output=new Subject_1.Subject,'string'==typeof f?this.url=f:assign_1.assign(this,f),!this.WebSocketCtor)throw new Error('no WebSocket constructor can be found');this.destination=new ReplaySubject_1.ReplaySubject}}return __extends(c,a),c.prototype.resultSelector=function(f){return JSON.parse(f.data)},c.create=function(f){return new c(f)},c.prototype.lift=function(f){var g=new c(this,this.destination);return g.operator=f,g},c.prototype.multiplex=function(f,g,h){var i=this;return new Observable_1.Observable(function(j){var k=tryCatch_1.tryCatch(f)();k===errorObject_1.errorObject?j.error(errorObject_1.errorObject.e):i.next(k);var l=i.subscribe(function(m){var n=tryCatch_1.tryCatch(h)(m);n===errorObject_1.errorObject?j.error(errorObject_1.errorObject.e):n&&j.next(m)},function(m){return j.error(m)},function(){return j.complete()});return function(){var m=tryCatch_1.tryCatch(g)();m===errorObject_1.errorObject?j.error(errorObject_1.errorObject.e):i.next(m),l.unsubscribe()}})},c.prototype._connectSocket=function(){var f=this,g=this.WebSocketCtor,h=this._output,i=null;try{i=this.protocol?new g(this.url,this.protocol):new g(this.url),this.socket=i}catch(k){return void h.error(k)}var j=new Subscription_1.Subscription(function(){f.socket=null,i&&1===i.readyState&&i.close()});i.onopen=function(k){var l=f.openObserver;l&&l.next(k);var m=f.destination;f.destination=Subscriber_1.Subscriber.create(function(n){return 1===i.readyState&&i.send(n)},function(n){var o=f.closingObserver;o&&o.next(void 0),n&&n.code?i.close(n.code,n.reason):h.error(new TypeError('WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }')),f.destination=new ReplaySubject_1.ReplaySubject,f.socket=null},function(){var n=f.closingObserver;n&&n.next(void 0),i.close(),f.destination=new ReplaySubject_1.ReplaySubject,f.socket=null}),m&&m instanceof ReplaySubject_1.ReplaySubject&&j.add(m.subscribe(f.destination))},i.onerror=function(k){return h.error(k)},i.onclose=function(k){var l=f.closeObserver;l&&l.next(k),k.wasClean?h.complete():h.error(k)},i.onmessage=function(k){var l=tryCatch_1.tryCatch(f.resultSelector)(k);l===errorObject_1.errorObject?h.error(errorObject_1.errorObject.e):h.next(l)}},c.prototype._subscribe=function(f){var g=this,h=this.source;if(h)return h.subscribe(f);this.socket||this._connectSocket();var i=new Subscription_1.Subscription;return i.add(this._output.subscribe(f)),i.add(function(){var j=g.socket;0===g._output.observers.length&&j&&1===j.readyState&&(j.close(),g.socket=null)}),i},c.prototype.unsubscribe=function(){var f=this,g=f.source,h=f.socket;h&&1===h.readyState&&(h.close(),this.socket=null),a.prototype.unsubscribe.call(this),g||(this.destination=new ReplaySubject_1.ReplaySubject)},c}(Subject_1.AnonymousSubject);exports.WebSocketSubject=WebSocketSubject;