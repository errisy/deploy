'use strict';var __extends=this&&this.__extends||function(a,c){function e(){this.constructor=a}for(var f in c)c.hasOwnProperty(f)&&(a[f]=c[f]);a.prototype=null===c?Object.create(c):(e.prototype=c.prototype,new e)},async_1=require('../scheduler/async'),Subscriber_1=require('../Subscriber'),isScheduler_1=require('../util/isScheduler');function bufferTime(a){var c=arguments.length,e=async_1.async;isScheduler_1.isScheduler(arguments[arguments.length-1])&&(e=arguments[arguments.length-1],c--);var f=null;2<=c&&(f=arguments[1]);var g=Number.POSITIVE_INFINITY;return 3<=c&&(g=arguments[2]),this.lift(new BufferTimeOperator(a,f,g,e))}exports.bufferTime=bufferTime;var BufferTimeOperator=function(){function a(c,e,f,g){this.bufferTimeSpan=c,this.bufferCreationInterval=e,this.maxBufferSize=f,this.scheduler=g}return a.prototype.call=function(c,e){return e._subscribe(new BufferTimeSubscriber(c,this.bufferTimeSpan,this.bufferCreationInterval,this.maxBufferSize,this.scheduler))},a}(),Context=function(){return function(){this.buffer=[]}}(),BufferTimeSubscriber=function(a){function c(e,f,g,h,j){a.call(this,e),this.bufferTimeSpan=f,this.bufferCreationInterval=g,this.maxBufferSize=h,this.scheduler=j,this.contexts=[];var k=this.openContext();if(this.timespanOnly=null==g||0>g,this.timespanOnly){var l={subscriber:this,context:k,bufferTimeSpan:f};this.add(k.closeAction=j.schedule(dispatchBufferTimeSpanOnly,f,l))}else{var m={subscriber:this,context:k},n={bufferTimeSpan:f,bufferCreationInterval:g,subscriber:this,scheduler:j};this.add(k.closeAction=j.schedule(dispatchBufferClose,f,m)),this.add(j.schedule(dispatchBufferCreation,g,n))}}return __extends(c,a),c.prototype._next=function(e){for(var h,f=this.contexts,g=f.length,j=0;j<g;j++){var k=f[j],l=k.buffer;l.push(e),l.length==this.maxBufferSize&&(h=k)}h&&this.onBufferFull(h)},c.prototype._error=function(e){this.contexts.length=0,a.prototype._error.call(this,e)},c.prototype._complete=function(){for(var h,e=this,f=e.contexts,g=e.destination;0<f.length;)h=f.shift(),g.next(h.buffer);a.prototype._complete.call(this)},c.prototype._unsubscribe=function(){this.contexts=null},c.prototype.onBufferFull=function(e){this.closeContext(e);var f=e.closeAction;if(f.unsubscribe(),this.remove(f),this.timespanOnly){e=this.openContext();var g=this.bufferTimeSpan,h={subscriber:this,context:e,bufferTimeSpan:g};this.add(e.closeAction=this.scheduler.schedule(dispatchBufferTimeSpanOnly,g,h))}},c.prototype.openContext=function(){var e=new Context;return this.contexts.push(e),e},c.prototype.closeContext=function(e){this.destination.next(e.buffer);var f=this.contexts,g=f?f.indexOf(e):-1;0<=g&&f.splice(f.indexOf(e),1)},c}(Subscriber_1.Subscriber);function dispatchBufferTimeSpanOnly(a){var c=a.subscriber,e=a.context;e&&c.closeContext(e),c.closed||(a.context=c.openContext(),a.context.closeAction=this.schedule(a,a.bufferTimeSpan))}function dispatchBufferCreation(a){var c=a.bufferCreationInterval,e=a.bufferTimeSpan,f=a.subscriber,g=a.scheduler,h=f.openContext(),j=this;f.closed||(f.add(h.closeAction=g.schedule(dispatchBufferClose,e,{subscriber:f,context:h})),j.schedule(a,c))}function dispatchBufferClose(a){var c=a.subscriber,e=a.context;c.closeContext(e)}