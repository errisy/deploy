"use strict";var __extends=function(a,c){function e(){this.constructor=a}for(var f in c)c.hasOwnProperty(f)&&(a[f]=c[f]);a.prototype=null===c?Object.create(c):(e.prototype=c.prototype,new e)},Subscriber_1=require("rxjs/Subscriber"),Subscription_1=require("rxjs/Subscription"),Observable_1=require("rxjs/Observable"),Subject_1=require("rxjs/Subject"),Map_1=require("rxjs/util/Map"),FastMap_1=require("rxjs/util/FastMap");function groupBy(a,c,e){return this.lift(new GroupByOperator(this,a,c,e))}exports.groupBy=groupBy;var GroupByOperator=function(){function a(c,e,f,g){this.source=c,this.keySelector=e,this.elementSelector=f,this.durationSelector=g}return a.prototype.call=function(c,e){return e._subscribe(new GroupBySubscriber(c,this.keySelector,this.elementSelector,this.durationSelector))},a}(),GroupBySubscriber=function(a){function c(e,f,g,h){a.call(this,e),this.keySelector=f,this.elementSelector=g,this.durationSelector=h,this.groups=null,this.attemptedToUnsubscribe=!1,this.count=0}return __extends(c,a),c.prototype._next=function(e){var f;try{f=this.keySelector(e)}catch(g){return void this.error(g)}this._group(e,f)},c.prototype._group=function(e,f){var g=this.groups;g||(g=this.groups="string"==typeof f?new FastMap_1.FastMap:new Map_1.Map);var i,h=g.get(f);if(this.elementSelector)try{i=this.elementSelector(e)}catch(l){this.error(l)}else i=e;if(!h){g.set(f,h=new Subject_1.Subject);var j=new GroupedObservable(f,h,this);if(this.destination.next(j),this.durationSelector){var k;try{k=this.durationSelector(new GroupedObservable(f,h))}catch(l){return void this.error(l)}this.add(k.subscribe(new GroupDurationSubscriber(f,h,this)))}}h.closed||h.next(i)},c.prototype._error=function(e){var f=this.groups;f&&(f.forEach(function(g){g.error(e)}),f.clear()),this.destination.error(e)},c.prototype._complete=function(){var e=this.groups;e&&(e.forEach(function(f){f.complete()}),e.clear()),this.destination.complete()},c.prototype.removeGroup=function(e){this.groups.delete(e)},c.prototype.unsubscribe=function(){this.closed||this.attemptedToUnsubscribe||(this.attemptedToUnsubscribe=!0,0===this.count&&a.prototype.unsubscribe.call(this))},c}(Subscriber_1.Subscriber),GroupDurationSubscriber=function(a){function c(e,f,g){a.call(this),this.key=e,this.group=f,this.parent=g}return __extends(c,a),c.prototype._next=function(){this._complete()},c.prototype._error=function(e){var f=this.group;f.closed||f.error(e),this.parent.removeGroup(this.key)},c.prototype._complete=function(){var e=this.group;e.closed||e.complete(),this.parent.removeGroup(this.key)},c}(Subscriber_1.Subscriber),GroupedObservable=function(a){function c(e,f,g){a.call(this),this.key=e,this.groupSubject=f,this.refCountSubscription=g}return __extends(c,a),c.prototype._subscribe=function(e){var f=new Subscription_1.Subscription,g=this,h=g.refCountSubscription,i=g.groupSubject;return h&&!h.closed&&f.add(new InnerRefCountSubscription(h)),f.add(i.subscribe(e)),f},c}(Observable_1.Observable);exports.GroupedObservable=GroupedObservable;var InnerRefCountSubscription=function(a){function c(e){a.call(this),this.parent=e,e.count++}return __extends(c,a),c.prototype.unsubscribe=function(){var e=this.parent;e.closed||this.closed||(a.prototype.unsubscribe.call(this),e.count-=1,0===e.count&&e.attemptedToUnsubscribe&&e.unsubscribe())},c}(Subscription_1.Subscription);