"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},__extends=function(a,e){function f(){this.constructor=a}for(var g in e)e.hasOwnProperty(g)&&(a[g]=e[g]);a.prototype=null===e?Object.create(e):(f.prototype=e.prototype,new f)},Observable_1=require("rxjs/Observable"),Notification_1=require("rxjs/Notification"),ColdObservable_1=require("rxjs/testing/ColdObservable"),HotObservable_1=require("rxjs/testing/HotObservable"),SubscriptionLog_1=require("rxjs/testing/SubscriptionLog"),VirtualTimeScheduler_1=require("rxjs/scheduler/VirtualTimeScheduler"),defaultMaxFrame=750,TestScheduler=function(a){function e(f){a.call(this,VirtualTimeScheduler_1.VirtualAction,defaultMaxFrame),this.assertDeepEqual=f,this.hotObservables=[],this.coldObservables=[],this.flushTests=[]}return __extends(e,a),e.prototype.createTime=function(f){var g=f.indexOf("|");if(-1===g)throw new Error("marble diagram for time should have a completion marker \"|\"");return g*e.frameTimeFactor},e.prototype.createColdObservable=function(f,g,h){if(-1!==f.indexOf("^"))throw new Error("cold observable cannot have subscription offset \"^\"");if(-1!==f.indexOf("!"))throw new Error("cold observable cannot have unsubscription marker \"!\"");var j=e.parseMarbles(f,g,h),k=new ColdObservable_1.ColdObservable(j,this);return this.coldObservables.push(k),k},e.prototype.createHotObservable=function(f,g,h){if(-1!==f.indexOf("!"))throw new Error("hot observable cannot have unsubscription marker \"!\"");var j=e.parseMarbles(f,g,h),k=new HotObservable_1.HotObservable(j,this);return this.hotObservables.push(k),k},e.prototype.materializeInnerObservable=function(f,g){var h=this,j=[];return f.subscribe(function(k){j.push({frame:h.frame-g,notification:Notification_1.Notification.createNext(k)})},function(k){j.push({frame:h.frame-g,notification:Notification_1.Notification.createError(k)})},function(){j.push({frame:h.frame-g,notification:Notification_1.Notification.createComplete()})}),j},e.prototype.expectObservable=function(f,g){var h=this;void 0===g&&(g=null);var m,j=[],k={actual:j,ready:!1},l=e.parseMarblesAsSubscriptions(g).unsubscribedFrame;return this.schedule(function(){m=f.subscribe(function(n){var o=n;n instanceof Observable_1.Observable&&(o=h.materializeInnerObservable(o,h.frame)),j.push({frame:h.frame,notification:Notification_1.Notification.createNext(o)})},function(n){j.push({frame:h.frame,notification:Notification_1.Notification.createError(n)})},function(){j.push({frame:h.frame,notification:Notification_1.Notification.createComplete()})})},0),l!==Number.POSITIVE_INFINITY&&this.schedule(function(){return m.unsubscribe()},l),this.flushTests.push(k),{toBe:function(o,q,r){k.ready=!0,k.expected=e.parseMarbles(o,q,r,!0)}}},e.prototype.expectSubscriptions=function(f){var g={actual:f,ready:!1};return this.flushTests.push(g),{toBe:function(j){var k="string"==typeof j?[j]:j;g.ready=!0,g.expected=k.map(function(l){return e.parseMarblesAsSubscriptions(l)})}}},e.prototype.flush=function(){for(var f=this.hotObservables;0<f.length;)f.shift().setup();a.prototype.flush.call(this);for(var h,g=this.flushTests.filter(function(j){return j.ready});0<g.length;)h=g.shift(),this.assertDeepEqual(h.actual,h.expected)},e.parseMarblesAsSubscriptions=function(f){if("string"!=typeof f)return new SubscriptionLog_1.SubscriptionLog(Number.POSITIVE_INFINITY);for(var g=f.length,h=-1,j=Number.POSITIVE_INFINITY,k=Number.POSITIVE_INFINITY,l=0;l<g;l++){var m=l*this.frameTimeFactor,n=f[l];switch(n){case"-":case" ":break;case"(":h=m;break;case")":h=-1;break;case"^":if(j!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");j=-1<h?h:m;break;case"!":if(k!==Number.POSITIVE_INFINITY)throw new Error("found a second subscription point '^' in a subscription marble diagram. There can only be one.");k=-1<h?h:m;break;default:throw new Error("there can only be '^' and '!' markers in a subscription marble diagram. Found instead '"+n+"'.");}}return 0>k?new SubscriptionLog_1.SubscriptionLog(j):new SubscriptionLog_1.SubscriptionLog(j,k)},e.parseMarbles=function(f,g,h,j){if(void 0===j&&(j=!1),-1!==f.indexOf("!"))throw new Error("conventional marble diagrams cannot have the unsubscription marker \"!\"");for(var k=f.length,l=[],m=f.indexOf("^"),n=-1===m?0:m*-this.frameTimeFactor,o="object"===("undefined"==typeof g?"undefined":_typeof(g))?function(v){return j&&g[v]instanceof ColdObservable_1.ColdObservable?g[v].messages:g[v]}:function(v){return v},q=-1,r=0;r<k;r++){var s=r*this.frameTimeFactor+n,t=void 0,u=f[r];switch(u){case"-":case" ":break;case"(":q=s;break;case")":q=-1;break;case"|":t=Notification_1.Notification.createComplete();break;case"^":break;case"#":t=Notification_1.Notification.createError(h||"error");break;default:t=Notification_1.Notification.createNext(o(u));}t&&l.push({frame:-1<q?q:s,notification:t})}return l},e}(VirtualTimeScheduler_1.VirtualTimeScheduler);exports.TestScheduler=TestScheduler;