"use strict";var root_1=require("rxjs/util/root"),ImmediateDefinition=function(){function a(b){if(this.root=b,b.setImmediate&&"function"==typeof b.setImmediate)this.setImmediate=b.setImmediate.bind(b),this.clearImmediate=b.clearImmediate.bind(b);else{this.nextHandle=1,this.tasksByHandle={},this.currentlyRunningATask=!1,this.setImmediate=this.canUseProcessNextTick()?this.createProcessNextTickSetImmediate():this.canUsePostMessage()?this.createPostMessageSetImmediate():this.canUseMessageChannel()?this.createMessageChannelSetImmediate():this.canUseReadyStateChange()?this.createReadyStateChangeSetImmediate():this.createSetTimeoutSetImmediate();var c=function d(e){delete d.instance.tasksByHandle[e]};c.instance=this,this.clearImmediate=c}}return a.prototype.identify=function(b){return this.root.Object.prototype.toString.call(b)},a.prototype.canUseProcessNextTick=function(){return"[object process]"===this.identify(this.root.process)},a.prototype.canUseMessageChannel=function(){return!!this.root.MessageChannel},a.prototype.canUseReadyStateChange=function(){var b=this.root.document;return!!(b&&"onreadystatechange"in b.createElement("script"))},a.prototype.canUsePostMessage=function(){var b=this.root;if(b.postMessage&&!b.importScripts){var c=!0,d=b.onmessage;return b.onmessage=function(){c=!1},b.postMessage("","*"),b.onmessage=d,c}return!1},a.prototype.partiallyApplied=function(b){for(var c=[],d=1;d<arguments.length;d++)c[d-1]=arguments[d];var e=function f(){var g=f,h=g.handler,i=g.args;"function"==typeof h?h.apply(void 0,i):new Function(""+h)()};return e.handler=b,e.args=c,e},a.prototype.addFromSetImmediateArguments=function(b){return this.tasksByHandle[this.nextHandle]=this.partiallyApplied.apply(void 0,b),this.nextHandle++},a.prototype.createProcessNextTickSetImmediate=function(){var b=function c(){var d=c.instance,e=d.addFromSetImmediateArguments(arguments);return d.root.process.nextTick(d.partiallyApplied(d.runIfPresent,e)),e};return b.instance=this,b},a.prototype.createPostMessageSetImmediate=function(){var b=this.root,c="setImmediate$"+b.Math.random()+"$",d=function f(g){var h=f.instance;g.source===b&&"string"==typeof g.data&&0===g.data.indexOf(c)&&h.runIfPresent(+g.data.slice(c.length))};d.instance=this,b.addEventListener("message",d,!1);var e=function f(){var g=f,h=g.messagePrefix,i=g.instance,j=i.addFromSetImmediateArguments(arguments);return i.root.postMessage(h+j,"*"),j};return e.instance=this,e.messagePrefix=c,e},a.prototype.runIfPresent=function(b){if(this.currentlyRunningATask)this.root.setTimeout(this.partiallyApplied(this.runIfPresent,b),0);else{var c=this.tasksByHandle[b];if(c){this.currentlyRunningATask=!0;try{c()}finally{this.clearImmediate(b),this.currentlyRunningATask=!1}}}},a.prototype.createMessageChannelSetImmediate=function(){var b=this,c=new this.root.MessageChannel;c.port1.onmessage=function(e){var f=e.data;b.runIfPresent(f)};var d=function e(){var f=e,g=f.channel,h=f.instance,i=h.addFromSetImmediateArguments(arguments);return g.port2.postMessage(i),i};return d.channel=c,d.instance=this,d},a.prototype.createReadyStateChangeSetImmediate=function(){var b=function c(){var d=c.instance,e=d.root,f=e.document,g=f.documentElement,h=d.addFromSetImmediateArguments(arguments),i=f.createElement("script");return i.onreadystatechange=function(){d.runIfPresent(h),i.onreadystatechange=null,g.removeChild(i),i=null},g.appendChild(i),h};return b.instance=this,b},a.prototype.createSetTimeoutSetImmediate=function(){var b=function c(){var d=c.instance,e=d.addFromSetImmediateArguments(arguments);return d.root.setTimeout(d.partiallyApplied(d.runIfPresent,e),0),e};return b.instance=this,b},a}();exports.ImmediateDefinition=ImmediateDefinition,exports.Immediate=new ImmediateDefinition(root_1.root);