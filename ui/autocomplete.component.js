"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},__decorate=function(a,b,f,g){var l,h=arguments.length,j=3>h?b:null===g?g=Object.getOwnPropertyDescriptor(b,f):g;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)j=Reflect.decorate(a,b,f,g);else for(var m=a.length-1;0<=m;m--)(l=a[m])&&(j=(3>h?l(j):3<h?l(b,f,j):l(b,f))||j);return 3<h&&j&&Object.defineProperty(b,f,j),j},__metadata=function(a,b){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)},core_1=require("@angular/core"),core_2=require("@angular/core"),forms_1=require("@angular/forms");function setProperty(a,b,f,g){a.setElementProperty(b.nativeElement,f,g)}var sanitize_1=require("ui/sanitize"),autocomplete_container_1=require("ui/autocomplete-container"),options_class_1=require("ui/options.class"),Autocomplete=function(){function a(f,g,h,j){this.cd=f,this.element=g,this.renderer=h,this.loader=j,this.autocompleteLoading=new core_2.EventEmitter,this.autocompleteNoResults=new core_2.EventEmitter,this.autocompleteOnSelect=new core_2.EventEmitter,this.autocompleteAsync=null,this.autocompleteLatinize=!0,this.autocompleteSingleWords=!0,this.autocompleteWordDelimiters=" ",this.autocompletePhraseDelimiters="'\"",this._matches=[],this.placement="bottom-left"}return Object.defineProperty(a.prototype,"matches",{get:function(){return this._matches},enumerable:!0,configurable:!0}),a.prototype.debounce=function(f,g){var h,j,l,m=g;return function(){j=[].slice.call(arguments,0),l=Date.now(),g=this.container?m:this.autocompleteWaitMs;h||(h=setTimeout(function o(){var p=Date.now()-l;p<g?h=setTimeout(o,g-p):(h=null,f.apply(this,j))},g))}},a.prototype.processMatches=function(){if(this._matches=[],this.cd.model.toString().length>=this.autocompleteMinLength){var f=(this.autocompleteLatinize?sanitize_1.AutocompleteUtils.latinize(this.cd.model):this.cd.model).toString().toLowerCase();f=this.autocompleteSingleWords?sanitize_1.AutocompleteUtils.tokenize(f,this.autocompleteWordDelimiters,this.autocompletePhraseDelimiters):f;for(var h,g=0;g<this.autocomplete.length;g++){if(h=void 0,"object"===_typeof(this.autocomplete[g])&&this.autocomplete[g][this.autocompleteOptionField]&&(h=this.autocompleteLatinize?sanitize_1.AutocompleteUtils.latinize(this.autocomplete[g][this.autocompleteOptionField].toString()):this.autocomplete[g][this.autocompleteOptionField].toString()),"string"==typeof this.autocomplete[g]&&(h=this.autocompleteLatinize?sanitize_1.AutocompleteUtils.latinize(this.autocomplete[g].toString()):this.autocomplete[g].toString()),!h){console.log("Invalid match type",_typeof(this.autocomplete[g]),this.autocompleteOptionField);continue}if(this.testMatch(h.toLowerCase(),f)&&(this._matches.push(this.autocomplete[g]),this._matches.length>this.autocompleteOptionsLimit-1))break}}},a.prototype.testMatch=function(f,g){var h;if("object"===("undefined"==typeof g?"undefined":_typeof(g))){h=g.length;for(var j=0;j<h;j+=1)if(0<g[j].length&&0>f.indexOf(g[j]))return!1;return!0}return 0<=f.indexOf(g)},a.prototype.finalizeAsyncCall=function(){if(this.autocompleteLoading.emit(!1),this.autocompleteNoResults.emit(this.cd.model.toString().length>=this.autocompleteMinLength&&0>=this.matches.length),0>=this.cd.model.toString().length||0>=this._matches.length)return void this.hide();if(this.container&&0<this._matches.length){var f=(this.autocompleteLatinize?sanitize_1.AutocompleteUtils.latinize(this.cd.model):this.cd.model).toString().toLowerCase();this.container.query=this.autocompleteSingleWords?sanitize_1.AutocompleteUtils.tokenize(f,this.autocompleteWordDelimiters,this.autocompletePhraseDelimiters):f,this.container.matches=this._matches}!this.container&&0<this._matches.length&&this.show(this._matches)},a.prototype.ngOnInit=function(){var f=this;this.autocompleteOptionsLimit=this.autocompleteOptionsLimit||20,this.autocompleteMinLength=this.autocompleteMinLength||1,this.autocompleteWaitMs=this.autocompleteWaitMs||0,null===this.autocompleteAsync&&"function"!=typeof this.autocomplete&&(this.autocompleteAsync=!1),"function"==typeof this.autocomplete&&(this.autocompleteAsync=!0),!0===this.autocompleteAsync&&(this.debouncer=this.debounce(function(){"function"==typeof f.autocomplete&&f.autocomplete().then(function(g){if(f._matches=[],f.cd.model.toString().length>=f.autocompleteMinLength)for(var h=0;h<g.length&&(f._matches.push(g[h]),!(f._matches.length>f.autocompleteOptionsLimit-1));h++);f.finalizeAsyncCall()}),"object"===_typeof(f.autocomplete)&&f.autocomplete.length&&(f.processMatches(),f.finalizeAsyncCall())},100))},a.prototype.onChange=function(f){if(this.container){if(27===f.keyCode)return void this.hide();if(38===f.keyCode)return void this.container.prevActiveMatch();if(40===f.keyCode)return void this.container.nextActiveMatch();if(13===f.keyCode)return void this.container.selectActiveMatch()}this.autocompleteLoading.emit(!0),!0===this.autocompleteAsync&&this.debouncer(),!1===this.autocompleteAsync&&(this.processMatches(),this.finalizeAsyncCall())},a.prototype.changeModel=function(f){var g=("object"===("undefined"==typeof f?"undefined":_typeof(f))&&this.autocompleteOptionField?f[this.autocompleteOptionField]:f).toString();this.cd.viewToModelUpdate(g),setProperty(this.renderer,this.element,"value",g),this.hide()},a.prototype.show=function(f){var g=this,h=new options_class_1.AutocompleteOptions({placement:this.placement,animation:!1}),j=core_2.Injector.resolve([new Provider(options_class_1.AutocompleteOptions,{useValue:h})]);this.popup=this.loader.loadNextToLocation(autocomplete_container_1.AutocompleteContainer,this.element,j).then(function(l){l.instance.position(g.element),g.container=l.instance,g.container.parent=g;var m=(g.autocompleteLatinize?sanitize_1.AutocompleteUtils.latinize(g.cd.model):g.cd.model).toString().toLowerCase();return g.container.query=g.autocompleteSingleWords?sanitize_1.AutocompleteUtils.tokenize(m,g.autocompleteWordDelimiters,g.autocompletePhraseDelimiters):m,g.container.matches=f,g.container.field=g.autocompleteOptionField,g.element.nativeElement.focus(),l})},a.prototype.hide=function(){var f=this;this.container&&this.popup.then(function(g){return g.dispose(),f.container=null,g})},__decorate([core_2.Output(),__metadata("design:type",core_2.EventEmitter)],a.prototype,"autocompleteLoading",void 0),__decorate([core_2.Output(),__metadata("design:type",core_2.EventEmitter)],a.prototype,"autocompleteNoResults",void 0),__decorate([core_2.Output(),__metadata("design:type",core_2.EventEmitter)],a.prototype,"autocompleteOnSelect",void 0),__decorate([core_2.Input(),__metadata("design:type",Object)],a.prototype,"autocomplete",void 0),__decorate([core_2.Input(),__metadata("design:type",Number)],a.prototype,"autocompleteMinLength",void 0),__decorate([core_2.Input(),__metadata("design:type",Number)],a.prototype,"autocompleteWaitMs",void 0),__decorate([core_2.Input(),__metadata("design:type",Number)],a.prototype,"autocompleteOptionsLimit",void 0),__decorate([core_2.Input(),__metadata("design:type",String)],a.prototype,"autocompleteOptionField",void 0),__decorate([core_2.Input(),__metadata("design:type",Boolean)],a.prototype,"autocompleteAsync",void 0),__decorate([core_2.Input(),__metadata("design:type",Boolean)],a.prototype,"autocompleteLatinize",void 0),__decorate([core_2.Input(),__metadata("design:type",Boolean)],a.prototype,"autocompleteSingleWords",void 0),__decorate([core_2.Input(),__metadata("design:type",String)],a.prototype,"autocompleteWordDelimiters",void 0),__decorate([core_2.Input(),__metadata("design:type",String)],a.prototype,"autocompletePhraseDelimiters",void 0),__decorate([core_2.HostListener("keyup",["$event"]),__metadata("design:type",Function),__metadata("design:paramtypes",[KeyboardEvent]),__metadata("design:returntype",void 0)],a.prototype,"onChange",null),a=__decorate([core_2.Directive({selector:"autocomplete[ngModel], [ngModel][autocomplete]"}),__metadata("design:paramtypes",[forms_1.NgModel,core_1.ElementRef,core_2.Renderer,"function"==typeof(b="undefined"!=typeof core_2.DynamicComponentLoader&&core_2.DynamicComponentLoader)&&b||Object])],a),a;var b}();exports.Autocomplete=Autocomplete;