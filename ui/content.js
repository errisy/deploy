"use strict";var _createClass=function(){function a(b,f){for(var h,g=0;g<f.length;g++)h=f[g],h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(b,h.key,h)}return function(b,f,g){return f&&a(b.prototype,f),g&&a(b,g),b}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,f=Array(a.length);b<a.length;b++)f[b]=a[b];return f}return Array.from(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var __decorate=function(a,b,f,g){var l,h=arguments.length,j=3>h?b:null===g?g=Object.getOwnPropertyDescriptor(b,f):g;if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.decorate)j=Reflect.decorate(a,b,f,g);else for(var m=a.length-1;0<=m;m--)(l=a[m])&&(j=(3>h?l(j):3<h?l(b,f,j):l(b,f))||j);return 3<h&&j&&Object.defineProperty(b,f,j),j},__metadata=function(a,b){if("object"===("undefined"==typeof Reflect?"undefined":_typeof(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)},__awaiter=function(a,b,f,g){return new(f||(f=Promise))(function(h,j){function l(o){try{n(g.next(o))}catch(p){j(p)}}function m(o){try{n(g["throw"](o))}catch(p){j(p)}}function n(o){o.done?h(o.value):new f(function(p){p(o.value)}).then(l,m)}n((g=g.apply(a,b)).next())})},core_1=require("@angular/core"),util=require("errisy-util");require("errisy-string");var errisy_ui_1=require("errisy-ui"),WithButtonFilter=function(){function a(){_classCallCheck(this,a)}return _createClass(a,[{key:"transform",value:function(f){return f.filter(function(h){return h.Button})}}]),a}();WithButtonFilter=__decorate([core_1.Pipe({name:"withbutton"}),__metadata("design:paramtypes",[])],WithButtonFilter),exports.WithButtonFilter=WithButtonFilter;var ContentControl=function(){function a(b){_classCallCheck(this,a),this.componentFactoryResolver=b,this.Components=[]}return _createClass(a,[{key:"isSelected",value:function(f){return this.CurrentComponent==f}},{key:"createContent",value:function(f){this.childViewReference&&this.childViewReference.destroy(),this.CurrentComponent=f;var g=this.componentFactoryResolver.resolveComponentFactory(f);this.childViewReference=this.container.createComponent(g)}},{key:"addTemplate",value:function(f,g,h,j,l){this.Components=[].concat(_toConsumableArray(this.Components),[{Component:f,Label:g,Link:h,Button:!j,Index:this.Components.length,Actions:l?l:[]}])}},{key:"select",value:function(f){this.createContent(this.Components[f].Component),this.onSelected&&this.onSelected(this.Components[f])}},{key:"isIndex",value:function(f){return this.Components[f]&&this.CurrentComponent==this.Components[f].Component}},{key:"navigate",value:function(f){for(var g=!1,h=0;h<this.Components.length;h++)if(this.Components[h].Link==f){this.select(h),g=!0;break}!g&&this.Components&&0<this.Components.length&&this.select(0)}},{key:"login",value:function(f,g){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function h(){return regeneratorRuntime.wrap(function(l){for(;;)switch(l.prev=l.next){case 0:if(!this.LoginClient){l.next=13;break}return l.next=3,this.LoginClient.login(f,g);case 3:if(!l.sent){l.next=9;break}return this.isLogin=!0,this.Status="Ready.",l.abrupt("return",!0);case 9:return this.Status="Wrong username or password.",l.abrupt("return",!1);case 11:l.next=15;break;case 13:return this.Status="Login was not defined.",l.abrupt("return",!1);case 15:case"end":return l.stop();}},h,this)}))}},{key:"checkLogin",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(!this.isLogin){h.next=2;break}return h.abrupt("return",!0);case 2:return h.abrupt("return",this.tryLogin());case 3:case"end":return h.stop();}},f,this)}))}},{key:"tryLogin",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){var g;return regeneratorRuntime.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(!this.LoginClient){j.next=17;break}return j.next=3,this.$loginCleint.trylogin();case 3:if(g=j.sent,!g.success){j.next=11;break}return this.isLogin=!0,this.Status="Ready.",this.username=g.username,j.abrupt("return",!0);case 11:return this.isLogin=!1,this.Status="Auto-Login Failed.",this.username=g.username,j.abrupt("return",!1);case 15:j.next=18;break;case 17:this.Status="Login was not defined.";case 18:case"end":return j.stop();}},f,this)}))}},{key:"ChildView",get:function(){return this.childViewReference?this.childViewReference.instance:void 0}},{key:"LoginClient",get:function(){return this.$loginCleint},set:function(f){this.$loginCleint=f,this.$loginCleint&&this.$loginComponent&&this.$loginComponent.tryLogin()}},{key:"LoginComponent",get:function(){return this.$loginComponent},set:function(f){this.$loginComponent=f,this.$loginCleint&&this.$loginComponent&&this.$loginComponent.tryLogin()}}]),a}();__decorate([core_1.ViewChild("container",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],ContentControl.prototype,"container",void 0),ContentControl=__decorate([core_1.Component({selector:"[content]",template:"<div #container></div>"}),__metadata("design:paramtypes",[core_1.ComponentFactoryResolver])],ContentControl),exports.ContentControl=ContentControl;var ComponentTemplate=function a(){_classCallCheck(this,a)};exports.ComponentTemplate=ComponentTemplate;var LoginComponentModel=function(){function a(b,f){_classCallCheck(this,a),this.changeDetectorRef=b,this.parent=f,this.LoginEntity={Username:"",Password:"",Long:!1},this.UserEntity={Username:""}}return _createClass(a,[{key:"ngAfterContentInit",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(!this.onLoad){h.next=3;break}return h.next=3,this.onLoad();case 3:this.changeDetectorRef.detectChanges();case 4:case"end":return h.stop();}},f,this)}))}},{key:"onLoad",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,this.parent.tryLogin();case 2:if(!h.sent){h.next=8;break}return this.UserEntity.Username=this.parent.username,h.next=6,this.toUser();case 6:h.next=10;break;case 8:return h.next=10,this.toLogin();case 10:case"end":return h.stop();}},f,this)}))}},{key:"tryLogin",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return h.next=2,this.parent.tryLogin();case 2:if(!h.sent){h.next=6;break}return this.UserEntity.Username=this.parent.username,h.next=6,this.toUser();case 6:case"end":return h.stop();}},f,this)}))}},{key:"toLogin",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:this.Title="Login",this.View.Entity=this.LoginEntity,this.View.Load(this.LoginView);case 3:case"end":return h.stop();}},f,this)}))}},{key:"onLogin",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(this.parent.LoginClient){h.next=3;break}return this.parent.Status="Login Service is not Available!",h.abrupt("return");case 3:return this.parent.Status="Trying to Login...",h.next=6,this.parent.LoginClient.login(this.LoginEntity.Username,util.md5(this.LoginEntity.Password),this.LoginEntity.Long);case 6:if(!h.sent){h.next=13;break}return this.parent.username=this.LoginEntity.Username,this.parent.Status="Login Success!",h.next=11,this.toUser();case 11:h.next=14;break;case 13:this.parent.Status="Login Failed!";case 14:case"end":return h.stop();}},f,this)}))}},{key:"onLoginByKeyDown",value:function(f){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function g(){return regeneratorRuntime.wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if("Enter"!=f.key){j.next=4;break}return j.next=3,this.onLogin();case 3:this.changeDetectorRef.detectChanges();case 4:case"end":return j.stop();}},g,this)}))}},{key:"toRegister",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:this.Title="Registration",this.View.Entity=this.RegisterEntity,this.View.Load(this.RegisterView);case 3:case"end":return h.stop();}},f,this)}))}},{key:"toUser",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:this.Title="User",this.UserEntity.Username=this.parent.username,this.View.Entity=this.UserEntity,this.View.Load(this.UserView);case 4:case"end":return h.stop();}},f,this)}))}},{key:"onLogout",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(!(this.parent.LoginClient&&this.parent.LoginClient.logout)){h.next=3;break}return h.next=3,this.parent.LoginClient.logout();case 3:this.LoginEntity.Username=this.parent.username,this.LoginEntity.Password="",this.toLogin();case 6:case"end":return h.stop();}},f,this)}))}},{key:"toRetrieve",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:if(this.Title="Retrieve Password",!this.toRetrieveExtends){h.next=4;break}return h.next=4,this.toRetrieveExtends();case 4:this.View.Entity=this.RetrieveEntity,this.View.Load(this.RetrieveView);case 6:case"end":return h.stop();}},f,this)}))}},{key:"toRetrieveExtends",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function f(){return regeneratorRuntime.wrap(function(h){for(;;)switch(h.prev=h.next){case 0:case"end":return h.stop();}},f,this)}))}},{key:"Title",get:function(){return this.parent.Title},set:function(f){this.parent.Title=f}},{key:"LoginView",get:function(){return[[errisy_ui_1.fields.text("Username","Username").event("keydown",this,this.onLoginByKeyDown)],[errisy_ui_1.fields.password("Password","Password").event("keydown",this,this.onLoginByKeyDown)],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Regist").event("click",this,this.toRegister),errisy_ui_1.fields.submit("Login").event("click",this,this.onLogin)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("ForgetPassword","Retrieve Your Password").event("click",this,this.toRetrieve))]}},{key:"UserView",get:function(){return[[errisy_ui_1.fields.text("Username","Username").readonly()],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Logout").event("click",this,this.onLogout))]}}]),a}();__decorate([core_1.ViewChild("view"),__metadata("design:type",errisy_ui_1.InfoTableControl)],LoginComponentModel.prototype,"View",void 0),exports.LoginComponentModel=LoginComponentModel;