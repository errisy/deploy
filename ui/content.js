"use strict";var __decorate=this&&this.__decorate||function(a,b,f,g){var l,h=arguments.length,j=3>h?b:null===g?g=Object.getOwnPropertyDescriptor(b,f):g;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)j=Reflect.decorate(a,b,f,g);else for(var m=a.length-1;0<=m;m--)(l=a[m])&&(j=(3>h?l(j):3<h?l(b,f,j):l(b,f))||j);return 3<h&&j&&Object.defineProperty(b,f,j),j},__metadata=this&&this.__metadata||function(a,b){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(a,b)},__awaiter=this&&this.__awaiter||function(a,b,f,g){return new(f||(f=Promise))(function(h,j){function l(o){try{n(g.next(o))}catch(p){j(p)}}function m(o){try{n(g["throw"](o))}catch(p){j(p)}}function n(o){o.done?h(o.value):new f(function(p){p(o.value)}).then(l,m)}n((g=g.apply(a,b)).next())})};const core_1=require("@angular/core"),util=require("errisy-util");require("errisy-string");const errisy_ui_1=require("errisy-ui");let WithButtonFilter=class{transform(b){return b.filter(g=>g.Button)}};WithButtonFilter=__decorate([core_1.Pipe({name:"withbutton"}),__metadata("design:paramtypes",[])],WithButtonFilter),exports.WithButtonFilter=WithButtonFilter;let ContentControl=class{constructor(b){this.componentFactoryResolver=b,this.Components=[]}get ChildView(){return this.childViewReference?this.childViewReference.instance:void 0}isSelected(b){return this.CurrentComponent==b}createContent(b){this.childViewReference&&this.childViewReference.destroy(),this.CurrentComponent=b;let f=this.componentFactoryResolver.resolveComponentFactory(b);this.childViewReference=this.container.createComponent(f)}addTemplate(b,f,g,h,j){this.Components=[...this.Components,{Component:b,Label:f,Link:g,Button:!h,Index:this.Components.length,Actions:j?j:[]}]}select(b){this.createContent(this.Components[b].Component),this.onSelected&&this.onSelected(this.Components[b])}isIndex(b){return this.Components[b]&&this.CurrentComponent==this.Components[b].Component}navigate(b){let f=!1;for(let g=0;g<this.Components.length;g++)if(this.Components[g].Link==b){this.select(g),f=!0;break}!f&&this.Components&&0<this.Components.length&&this.select(0)}get LoginClient(){return this.$loginCleint}set LoginClient(b){this.$loginCleint=b,this.$loginCleint&&this.$loginComponent&&this.$loginComponent.tryLogin()}get LoginComponent(){return this.$loginComponent}set LoginComponent(b){this.$loginComponent=b,this.$loginCleint&&this.$loginComponent&&this.$loginComponent.tryLogin()}login(b,f){return __awaiter(this,void 0,void 0,function*(){return this.LoginClient?(yield this.LoginClient.login(b,f))?(this.isLogin=!0,this.Status="Ready.",!0):(this.Status="Wrong username or password.",!1):(this.Status="Login was not defined.",!1)})}checkLogin(){return __awaiter(this,void 0,void 0,function*(){return!!this.isLogin||this.tryLogin()})}tryLogin(){return __awaiter(this,void 0,void 0,function*(){if(this.LoginClient){let b=yield this.$loginCleint.trylogin();return b.success?(this.isLogin=!0,this.Status="Ready.",this.username=b.username,!0):(this.isLogin=!1,this.Status="Auto-Login Failed.",this.username=b.username,!1)}this.Status="Login was not defined."})}};__decorate([core_1.ViewChild("container",{read:core_1.ViewContainerRef}),__metadata("design:type",core_1.ViewContainerRef)],ContentControl.prototype,"container",void 0),ContentControl=__decorate([core_1.Component({selector:"[content]",template:"<div #container></div>"}),__metadata("design:paramtypes",[core_1.ComponentFactoryResolver])],ContentControl),exports.ContentControl=ContentControl;class ComponentTemplate{}exports.ComponentTemplate=ComponentTemplate;class LoginComponentModel{constructor(a,b){this.changeDetectorRef=a,this.parent=b,this.LoginEntity={Username:"",Password:"",Long:!1},this.UserEntity={Username:""}}ngAfterContentInit(){return __awaiter(this,void 0,void 0,function*(){this.onLoad&&(yield this.onLoad()),this.changeDetectorRef.detectChanges()})}get Title(){return this.parent.Title}set Title(a){this.parent.Title=a}onLoad(){return __awaiter(this,void 0,void 0,function*(){(yield this.parent.tryLogin())?(this.UserEntity.Username=this.parent.username,yield this.toUser()):yield this.toLogin()})}tryLogin(){return __awaiter(this,void 0,void 0,function*(){(yield this.parent.tryLogin())&&(this.UserEntity.Username=this.parent.username,yield this.toUser())})}get LoginView(){return[[errisy_ui_1.fields.text("Username","Username").event("keydown",this,this.onLoginByKeyDown)],[errisy_ui_1.fields.password("Password","Password").event("keydown",this,this.onLoginByKeyDown)],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Regist").event("click",this,this.toRegister),errisy_ui_1.fields.submit("Login").event("click",this,this.onLogin)),errisy_ui_1.rows.link(errisy_ui_1.fields.click("ForgetPassword","Retrieve Your Password").event("click",this,this.toRetrieve))]}toLogin(){return __awaiter(this,void 0,void 0,function*(){this.Title="Login",this.View.Entity=this.LoginEntity,this.View.Load(this.LoginView)})}onLogin(){return __awaiter(this,void 0,void 0,function*(){return this.parent.LoginClient?void(this.parent.Status="Trying to Login...",(yield this.parent.LoginClient.login(this.LoginEntity.Username,util.md5(this.LoginEntity.Password),this.LoginEntity.Long))?(this.parent.username=this.LoginEntity.Username,this.parent.Status="Login Success!",yield this.toUser()):this.parent.Status="Login Failed!"):void(this.parent.Status="Login Service is not Available!")})}onLoginByKeyDown(a){return __awaiter(this,void 0,void 0,function*(){"Enter"==a.key&&(yield this.onLogin(),this.changeDetectorRef.detectChanges())})}toRegister(){return __awaiter(this,void 0,void 0,function*(){this.Title="Registration",this.View.Entity=this.RegisterEntity,this.View.Load(this.RegisterView)})}get UserView(){return[[errisy_ui_1.fields.text("Username","Username").readonly()],errisy_ui_1.rows.buttons(errisy_ui_1.fields.submit("Logout").event("click",this,this.onLogout))]}toUser(){return __awaiter(this,void 0,void 0,function*(){this.Title="User",this.UserEntity.Username=this.parent.username,this.View.Entity=this.UserEntity,this.View.Load(this.UserView)})}onLogout(){return __awaiter(this,void 0,void 0,function*(){this.parent.LoginClient&&this.parent.LoginClient.logout&&(yield this.parent.LoginClient.logout()),this.LoginEntity.Username=this.parent.username,this.LoginEntity.Password="",this.toLogin()})}toRetrieve(){return __awaiter(this,void 0,void 0,function*(){this.Title="Retrieve Password",this.toRetrieveExtends&&(yield this.toRetrieveExtends()),this.View.Entity=this.RetrieveEntity,this.View.Load(this.RetrieveView)})}toRetrieveExtends(){return __awaiter(this,void 0,void 0,function*(){})}}__decorate([core_1.ViewChild("view"),__metadata("design:type",errisy_ui_1.InfoTableControl)],LoginComponentModel.prototype,"View",void 0),exports.LoginComponentModel=LoginComponentModel;